<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<styles>
  
</styles>
<body>
    <form action="" class="adminForm d-flex justify-content-center gap-5 my-5">
        <label for="selectDate"></label>
        <input required type="datetime-local" id="selectDate" class="p-3">
        <select required name="" id="duration"  class="p-3">
            <option value="">Select Duration</option>
            <option value="minTime">15 min</option>
            <option value="maxTime">30 min</option>
        </select>
        <button  class="p-3 px-5" type="submit">Submit</button>
    </form>

    <h2 class="text-center py-5">Your Available Slots</h2>
    <div class="adminContainer">
    </div>
    <!-- "admin": [
    {
      "meetingDetails": [
      { "status": "Active",
        "slot": "",
        "meetingLink": "", 
        "duration" : "" }
      ]
    }
  ] -->
</body>
<script src="https://apis.google.com/js/api.js"></script>

<script type="module">
    let fetchURL = `http://localhost:3000/admin`;

    let fetchData = async (url) => {
        let fetchdata = await fetch(url);
        let data = await fetchdata.json();
        return data;
    };

    let adminData = await fetchData(fetchURL);
    const urlParams = new URLSearchParams(window.location.search);
    let userId = urlParams.get('userId');
    let baseURL = `http://localhost:3000/admin/${userId}`;
    let curradmin = await fetchData(baseURL);

    let loggedUser = JSON.parse(localStorage.getItem("logged")) || false;

    let minTime = 15;
    let maxTime = 30;
    let adminForm = document.querySelector(".adminForm");

    let setAdminAvail = async (event) => {
        event.preventDefault();

        let selectedDateTime = new Date(event.target[0].value).getTime();
        let currentDateTime = new Date().getTime();

        if (selectedDateTime < currentDateTime) {
            alert("Please select a date and time that is not in the past.");
            return;
        }

        adminData.forEach((ele)=>{
            
        })

        let user = adminData.find(admin => admin.id === userId);
        let { meetingDetails } = user;

        let id = Math.random().toString();
        let slot = event.target[0].value;

        let date = new Date(slot); // Create Date object from UTC string
        slot = date.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

        let selectedTime = event.target[1].value;
        let duration = selectedTime === "maxTime" ? maxTime : minTime;

        let newMeeting = { id, slot, duration, status: "active", meetingLink: "" };
        let updatedMeetingDetails = [newMeeting, ...meetingDetails];



        await fetch(baseURL, {
            method: "PATCH",
            headers: {
                "content-type": 'application/json'
            },
            body: JSON.stringify({ meetingDetails: updatedMeetingDetails })
        });

        alert("Meeting added successfully");
    };

    adminForm.addEventListener("submit", setAdminAvail)

    let adminContainer = document.querySelector(".adminContainer")


    let showdata = async (ele) => {
        adminContainer.innerHTML = ""

        // data.forEach((ele) => {

        ele.meetingDetails.forEach(meeting => {
            let card = document.createElement("div")
            let meetingElement = document.createElement('div');
            meetingElement.classList.add('meeting');
            meetingElement.innerHTML = `
                    <p><strong>Slot:</strong> ${meeting.slot}</p>
                    <p><strong>Duration:</strong> ${meeting.duration} min</p>
                    <p><strong>Status:</strong> ${meeting.status}</p>
                        `;
                        let deleteBtn =  document.createElement("button")
                        deleteBtn.innerHTML = "Delete"
                        meetingElement.append(deleteBtn)
            card.append(meetingElement);

            deleteBtn.classList.add("px-5")
            meetingElement.classList.add("d-flex")
            meetingElement.classList.add("justify-content-evenly")
            
            adminContainer.append(card)
        });


        // });
    }

    showdata(curradmin)
</script>

</html>