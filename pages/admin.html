<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Integration</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        header>nav>ul>li>button {
            padding: 2px 5px;
            margin: auto;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #login_button {
            margin-bottom: 20px;
        }

        #logout_button {
            display: none;
            margin-bottom: 20px;
        }

        #calendarEvents {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
        }

        .event-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 8px;
            width: 250px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .event-card h3 {
            margin-top: 0;
        }

        .event-card a {
            display: block;
            margin-top: 10px;
            color: #007bff;
            text-decoration: none;
        }

        #eventModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        #eventModalContent {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 600px;
        }

        .close {
            cursor: pointer;
            float: right;
            font-size: 1.5em;
        }

        .share-button {
            margin-top: 10px;
            padding: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .share-button:hover {
            background-color: #0056b3;
        }


        form {

            input,
            select,
            option,
            button {
                border: 2px solid black;
                border-radius: 10px;
                font-weight: bold;
                color: rgba(0, 0, 0, 0.67);
            }
        }


        body {
            margin-top: 150px !important;
        }

        form {
            background: linear-gradient(rgb(255, 255, 255), rgba(32, 118, 217, 0.075), rgba(32, 124, 217, 0.251));
            /* background-color: lightblue; */
            padding: 6% 5%;
            border-radius: 15px;
        }

        /* .card { */
            /* text-transform: capitalize !important;
button{
    background-color: rgb(26, 72, 199);
}
        } */

        button {
            padding: 10px;
        }

        h2 {
            font-family: 'Gilroy-Heavy'
        }
    </style>
</head>

<body class="container">
    <header>
        <nav class="navbar">
            <div class="logo">
                <div class="logo1">
                    <img src="../image/Nav-image/logo_new-removebg-preview.png" alt="">
                </div>
            </div>
            <div class="menu-toggle" id="mobile-menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
            <ul class="nav-links">
                <li><a href="#features">Features</a></li>
                <li><a href="#pricing">Pricing</a></li>
                <li><a href="#support">Support</a></li>
                <li><a href="#contact">Contact</a></li>
                <li><button href="#login" class="btn-login" id="login_button" onclick="handleAuthClick()">Login with
                        Google</button></li>
                <li><button href="../index.html" class="btn-login" id="logout_button" onclick="handleSignOut()">Log
                        Out</button>
                </li>


            </ul>

        </nav>

    </header>

    <!-- <button id="login_button" onclick="handleAuthClick()">Login with Google</button>
    <button id="logout_button" onclick="handleSignOut()">Log Out</button> -->


    <div id="eventForm" class="container mx-auto ">
        <h2 class="text-center">Create New Event</h2>
        <form id="createEventForm" class="d-flex justify-content-center gap-5 my-5 flex-wrap">
            <p>

                <label for="eventSummary">Summary:</label>

                <input type="text" id="eventSummary" required>
            </p>
            <p>
                <label for="eventLocation">Location:</label>

                <input type="text" id="eventLocation">
            </p>

            <p>

                <label for="eventStart">Start Time:</label>
                <input type="datetime-local" id="eventStart" required>
            </p>
            <p>
                <label for="eventEnd">End Time:</label>
                <input type="datetime-local" id="eventEnd" required>
            </p>
            <p>

                <label for="notificationMethod">Notification Method:</label>
                <!-- <br> -->
                <select id="notificationMethod">
                    <option value="popup">Popup</option>
                    <option value="email">Email</option>
                </select>
            </p>
            <p>

                <label for="notificationMinutes">Minutes before:</label>
                <!-- <br> -->
                <input type="number" id="notificationMinutes" value="10" min="1" required>
            </p>
            <br>
            <button type="submit">Create Event</button>
        </form>
    </div>

    <div id="calendarEvents" class="mx-auto container d-flex justify-content-evenly gap-3 flex-wrap  "></div>

    <div id="eventModal">
        <div id="eventModalContent">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Event Details</h2>
            <p id="eventSummaryDetail"></p>
            <p id="eventLocationDetail"></p>
            <p id="eventStartDetail"></p>
            <p id="eventEndDetail"></p>
            <a id="eventInviteLink" href="#" target="_blank">Open Event in Google Calendar</a>
            <button class="share-button" onclick="shareEventLink()">Share Event Link</button>
            <input type="hidden" id="eventId">
            <button id="deleteEventButton">Delete Event</button>
        </div>
    </div>

    <script>



        const CLIENT_ID = '47711487762-mmrmlikaeeiuuv01bsuqr55lkopgkpl1.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDqnubOk-lMpKyn6fNO1-Qc4B-ca3bYRmc';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/calendar.events";
        const REDIRECT_URI = 'http://127.0.0.1:8080'; // Your redirect URI

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                redirect_uri: REDIRECT_URI,
                callback: handleAuthCallback,
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('login_button').style.visibility = 'visible';
            }
        }

        function handleAuthClick() {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function handleAuthCallback(response) {
            if (response.error) {
                console.error('Error during authentication:', response.error);
                alert('Authentication failed. Check the console for details.');
                return;
            }
            document.getElementById('login_button').style.display = 'none';
            document.getElementById('logout_button').style.display = 'inline-block';
            listUpcomingEvents();
        }

        async function listUpcomingEvents() {
            let response;
            try {
                response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': (new Date()).toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 10,
                    'orderBy': 'startTime'
                });
            } catch (err) {
                document.getElementById('calendarEvents').innerText = `Error: ${err.message}`;
                return;
            }

            const events = response.result.items;
            const eventsDiv = document.getElementById('calendarEvents');
            eventsDiv.innerHTML = '';

            if (events.length > 0) {
                console.log(events)
                events.forEach(event => {

                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card';
                    eventCard.classList.add = 'card';

                    const start = new Date(event.start.dateTime || event.start.date).toLocaleString();
                    const end = new Date(event.end.dateTime || event.end.date).toLocaleString();

                    eventCard.innerHTML = `
                        <h3>${event.summary}</h3>
                        <p><strong>Location:</strong> ${event.location || 'N/A'}</p>
                        <p><strong>Start:</strong> ${start}</p>
                        <p><strong>End:</strong> ${end}</p>
                        <a href="${event.htmlLink}" target="_blank">Open Event in Google Calendar</a>
                        <button onclick="viewEventDetails('${event.id}')">View Details</button>
                    `;
                    eventsDiv.appendChild(eventCard);

                });

                await storeEventsToJsonServer(events);

            } else {
                eventsDiv.innerHTML = '<p>No upcoming events found.</p>';
            }
            // console.log(data)

        }



        async function storeEventsToJsonServer(events) {
            try {
                // Fetch existing data from the server
                const response = await fetch('http://localhost:3000/events');
                let dbData = await response.json();

                // Initialize dbData.events as an empty array if it's undefined
                if (!dbData.events) {
                    dbData.events = [];
                }

                // Find existing record index or create a new one
                let userIndex = dbData.events.findIndex(user => user.id === events[0]?.creator?.email);

                if (userIndex === -1) {
                    // User not found, create a new record
                    dbData.events.push({
                        id: events[0].creator.email,
                        meetingDetails: events.map(event => ({
                            id: generateUniqueId(),
                            startTime: new Date(event.start.dateTime).toISOString(),
                            endTime: new Date(event.end.dateTime).toISOString(),
                            summary: event.summary,
                            link: event.htmlLink,
                            status: event.status || 'confirmed'
                        }))
                    });
                } else {
                    // User found, update or add new events to the user's meetingDetails
                    let updated = false;

                    events.forEach(event => {
                        let existingEventIndex = dbData.events[userIndex].meetingDetails.findIndex(
                            e => e.id === event.id
                        );

                        if (existingEventIndex !== -1) {
                            // Update existing event
                            dbData.events[userIndex].meetingDetails[existingEventIndex] = {
                                id: event.id,
                                startTime: new Date(event.start.dateTime).toISOString(),
                                endTime: new Date(event.end.dateTime).toISOString(),
                                summary: event.summary,
                                link: event.htmlLink,
                                status: event.status || 'confirmed'
                            };
                            updated = true;
                        } else {
                            // Add new event
                            dbData.events[userIndex].meetingDetails.push({
                                id: generateUniqueId(),
                                startTime: new Date(event.start.dateTime).toISOString(),
                                endTime: new Date(event.end.dateTime).toISOString(),
                                summary: event.summary,
                                link: event.htmlLink,
                                status: event.status || 'confirmed'
                            });
                            updated = true;
                        }
                    });

                    // If events were updated, send a PATCH request to update server data
                    if (updated) {
                        const updateResponse = await fetch(`http://localhost:3000/events/${dbData.events[userIndex].id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(dbData.events[userIndex])
                        });

                        if (!updateResponse.ok) {
                            throw new Error('Failed to update event data on the server');
                        }

                        console.log('Events successfully updated on JSON server for user:', dbData.events[userIndex].id);
                    }
                }

                // POST request to create new user data if userIndex was -1
                if (userIndex === -1) {
                    const createResponse = await fetch('http://localhost:3000/events', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dbData.events[dbData.events.length - 1])
                    });

                    if (!createResponse.ok) {
                        throw new Error('Failed to create new user data on the server');
                    }

                    console.log('New user data successfully stored on JSON server');
                }
            } catch (error) {
                console.error('Error storing events to JSON server:', error);
            }
        }

        // Example function to generate a unique ID (you may need a proper UUID library)
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Example function to generate a unique ID (you may need a proper UUID library)
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        async function createEvent(event) {
            event.preventDefault();

            const summary = document.getElementById('eventSummary').value;
            const location = document.getElementById('eventLocation').value;
            const start = document.getElementById('eventStart').value;
            const end = document.getElementById('eventEnd').value;
            const notificationMethod = document.getElementById('notificationMethod').value;
            const notificationMinutes = parseInt(document.getElementById('notificationMinutes').value, 10);

            const eventData = {
                summary: summary,
                location: location,
                start: {
                    dateTime: new Date(start).toISOString(),
                    timeZone: 'America/Los_Angeles',
                },
                end: {
                    dateTime: new Date(end).toISOString(),
                    timeZone: 'America/Los_Angeles',
                },
                reminders: {
                    useDefault: false,
                    overrides: [{
                        method: notificationMethod,
                        minutes: notificationMinutes
                    }]
                }
            };
            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': eventData
                });
                alert('Event created successfully!');
                listUpcomingEvents(); // Refresh the event list
            } catch (error) {
                console.error('Error creating event:', error);
                alert('Failed to create event. Check the console for details.');
            }

            //   console.log(eventData)
        }

        async function viewEventDetails(eventId) {
            try {
                const response = await gapi.client.calendar.events.get({
                    'calendarId': 'primary',
                    'eventId': eventId
                });

                const event = response.result;

                document.getElementById('eventSummaryDetail').innerText = `Summary: ${event.summary}`;
                document.getElementById('eventLocationDetail').innerText = `Location: ${event.location || 'N/A'}`;
                document.getElementById('eventStartDetail').innerText = `Start: ${new Date(event.start.dateTime || event.start.date).toLocaleString()}`;
                document.getElementById('eventEndDetail').innerText = `End: ${new Date(event.end.dateTime || event.end.date).toLocaleString()}`;
                document.getElementById('eventInviteLink').href = event.htmlLink;
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventModal').style.display = 'flex';
            } catch (error) {
                console.error('Error fetching event details:', error);
                alert('Failed to fetch event details. Check the console for details.');
            }
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        function shareEventLink() {
            const link = document.getElementById('eventInviteLink').href;
            navigator.clipboard.writeText(link).then(() => {
                alert('Event link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy the link:', err);
                alert('Failed to copy the link. Check the console for details.');
            });
        }

        async function deleteEvent() {
            const eventId = document.getElementById('eventId').value;

            try {
                await gapi.client.calendar.events.delete({
                    'calendarId': 'primary',
                    'eventId': eventId
                });
                alert('Event deleted successfully!');
                listUpcomingEvents(); // Refresh the event list
                closeModal(); // Hide the modal
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Failed to delete event. Check the console for details.');
            }
        }

        function handleSignOut() {
            gapi.auth2.getAuthInstance().signOut().then(() => {
                document.getElementById('login_button').style.display = 'inline-block';
                document.getElementById('logout_button').style.display = 'none';
                document.getElementById('calendarEvents').innerHTML = '';
                closeModal();
            });
        }

        let handleRedirect = () => {
            window.location.href = "../index.html"
        }

        let logout_button = document.getElementById("logout_button")
        logout_button.addEventListener("click", handleRedirect)
        document.getElementById('createEventForm').addEventListener('submit', createEvent);
        document.getElementById('deleteEventButton').addEventListener('click', deleteEvent);

        document.addEventListener("DOMContentLoaded", function () {
            const mobileMenu = document.getElementById("mobile-menu");
            const navLinks = document.querySelector(".nav-links");

            mobileMenu.addEventListener("click", function () {
                navLinks.classList.toggle("active");
            });

            //  calendar and form submission logic...
        });
    </script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>